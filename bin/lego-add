#!/bin/bash -eu

RESET=$(   echo -e '\033[0m'  )

BOLD=$(    echo -e '\033[1m'  )

BLACK=$(   echo -e '\033[30m' )
RED=$(     echo -e '\033[31m' )
GREEN=$(   echo -e '\033[32m' )
YELLOW=$(  echo -e '\033[33m' )
BLUE=$(    echo -e '\033[34m' )
MAGENTA=$( echo -e '\033[35m' )
CYAN=$(    echo -e '\033[36m' )
WHITE=$(   echo -e '\033[37m' )

help() {
  cat << END
Usage:
    lego add LEGO
END
  exit
}

usage() {
  help
  exit 1
}

copy_files() {
  tar -C "$1" -cvf - --exclude .keep . | tar -C "$2" -xf -
}

run_install() {
  cat <<END

  running gitd installation scripts...

END
  if [ -x "$1/install.sh" ]; then
    "$1/install.sh"
  fi
}

check_env() {

  if [ -e "$1/.env" ]; then
    cat <<END
###################################
${BOLD}You can edit configuration file at:${RESET}

    ${GREEN}$1/.env${RESET}
----

Or run '${GREEN}lego config $2${RESET}'
END
  fi
}

add() {
  if [[ $# > 0 ]]; then
    case "$1" in
      *help) help;;
    esac

    local legos="$(cd "$(dirname "${BASH_SOURCE[0]}")"/../lib/lego; pwd)"
    if [ -d "$legos/$1" ]; then

      mkdir -p "legos/$1"
      local d="$(cd "legos/$1";pwd)"

      copy_files "$legos/$1" "$d"

      check_env "$d" "$1"

      run_install "$d"

      lego-update

      echo
      echo done

      exit
    fi

    echo "$1 not found"
  fi

  usage
}

add "$@"
