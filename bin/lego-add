#!/bin/bash -eu

help() {
  cat << END
Usage:
    lego add LEGO
END
  exit
}

usage() {
  help
  exit 1
}


copy_files() {
  tar -C "$1" -cvf - --exclude .keep . | tar -C "$2" -xf -
}

run_install() {
  cat <<END

  running gitd installation scripts...

END
  if [ -x "$1/install.sh" ]; then
    "$1/install.sh"
  fi
}

check_env() {
  if [ -e "$1/.env" ]; then
    cat <<END
You can edit configuration file at:

    $1/.env
----

Or run 'lego config $2'
END
  fi
}

add() {
  if [[ $# > 0 ]]; then
    case "$1" in
      *help) help;;
    esac

    local legos="$(cd "$(dirname "${BASH_SOURCE[0]}")"/../lib/lego; pwd)"
    if [ -d "$legos/$1" ]; then

      mkdir -p "legos/$1"
      local d="$(cd "legos/$1";pwd)"

      copy_files "$legos/$1" "$d"

      run_install "$d"

      check_env "$d" "$1"

      lego-update

      echo
      echo done

      exit
    fi

    echo "$1 not found"
  fi

  usage
}

add "$@"
